AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  PipelineId:
    Type: String
  StageName:
    Type: String
  EndpointId:
    Type: String
  SourceVersion:
    Type: String
  Handler:
    Type: String
  Runtime:
    Type: String
  Method:
    Type: String
  Path:
    Type: String
  TrunkStackName:
    Type: String
  StageStackName:
    Type: String

Resources:
  Lambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "xilution-fox-${PipelineId}-${StageName}-${EndpointId}-lambda"
      Code:
        S3Bucket:
          Fn::ImportValue: !Sub "${TrunkStackName}-source-bucket"
        S3Key: !Sub "${SourceVersion}-function.zip"
      Layers:
        - Fn::ImportValue: !Sub "${StageStackName}-lambda-layer"
      Handler: !Ref Handler
      Runtime: !Ref Runtime
      Role:
        Fn::ImportValue: !Sub "${TrunkStackName}-lambda-role-arn"
  LambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::GetAtt:
          - Lambda
          - Arn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Join
        - ''
        - - 'arn:'
          - !Ref 'AWS::Partition'
          - ':execute-api:'
          - !Ref 'AWS::Region'
          - ':'
          - !Ref 'AWS::AccountId'
          - ':'
          - Fn::ImportValue: !Sub "${TrunkStackName}-api"
          - '/*/*'
  Integration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Fn::ImportValue: !Sub "${TrunkStackName}-api"
      IntegrationType: AWS_PROXY
      IntegrationMethod: POST
      IntegrationUri: !Join
        - ''
        - - 'arn:aws:apigateway:'
          - !Ref 'AWS::Region'
          - ':lambda:path//2015-03-31/functions/arn:aws:lambda:'
          - !Ref 'AWS::Region'
          - ':'
          - !Ref 'AWS::AccountId'
          - ':function:'
          - !Ref Lambda
          - '/invocations'
      ConnectionType: INTERNET
      PayloadFormatVersion: 2.0
  Route:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Fn::ImportValue: !Sub "${TrunkStackName}-api"
      RouteKey: !Sub "${Method} ${Path}"
      Target: !Join
        - /
        - - integrations
          - !Ref Integration
